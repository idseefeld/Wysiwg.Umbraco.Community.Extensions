{"version":3,"file":"wysiwg-base-block-editor-custom.view-Bzwoj4f9.js","sources":["../../../Wysiwg/src/blocks/views/wysiwg-base-block-editor-custom.view.ts"],"sourcesContent":["import {\r\n  customElement,\r\n  LitElement,\r\n  property,\r\n  PropertyValues,\r\n  state,\r\n} from \"@umbraco-cms/backoffice/external/lit\";\r\nimport { UmbElementMixin } from \"@umbraco-cms/backoffice/element-api\";\r\nimport type { UmbBlockEditorCustomViewConfiguration, UmbBlockEditorCustomViewElement } from \"@umbraco-cms/backoffice/block-custom-view\";\r\nimport {\r\n  UMB_PROPERTY_DATASET_CONTEXT,\r\n  UmbPropertyDatasetContext,\r\n  UmbPropertyValueDataPotentiallyWithEditorAlias,\r\n} from \"@umbraco-cms/backoffice/property\";\r\nimport { UmbBlockGridValueModel } from \"@umbraco-cms/backoffice/block-grid\";\r\nimport { UmbBlockDataModel, UmbBlockDataType, UmbBlockDataValueModel } from \"@umbraco-cms/backoffice/block\";\r\nimport { UpdateStatus } from \"../../util/updateStatusEnum\";\r\nimport { UMB_NOTIFICATION_CONTEXT, UmbNotificationContext } from \"@umbraco-cms/backoffice/notification\";\r\nimport { CommonUtilities } from \"../../util/common.utilities\";\r\nimport { Debugging, TransparentBackgroundColor } from \"../../constants\";\r\nimport { UMB_DOCUMENT_WORKSPACE_CONTEXT, UmbDocumentWorkspaceContext } from \"@umbraco-cms/backoffice/document\";\r\nimport { ColorType, LayoutSettings } from \"./types\";\r\n\r\nconst customElementName = \"wysiwg-base.block-editor-custom-view\";\r\n@customElement(customElementName)\r\nexport class WysiwgBaseBlockEditorCustomViewElement\r\n  extends UmbElementMixin(LitElement)\r\n  implements UmbBlockEditorCustomViewElement {\r\n\r\n  @property({ attribute: false })\r\n  content?: UmbBlockDataType;\r\n\r\n  @property({ attribute: false })\r\n  config?: UmbBlockEditorCustomViewConfiguration;\r\n\r\n  @property({ attribute: false })\r\n  settings?: UmbBlockDataType;\r\n\r\n  @state()\r\n  protected documentUnique = '';\r\n\r\n  @state()\r\n  protected datasetSettings?: UmbBlockDataModel[];\r\n\r\n  @state()\r\n  protected updateStatus: UpdateStatus | undefined = undefined;\r\n\r\n  protected _commonUtilities: CommonUtilities | undefined = undefined;\r\n\r\n  protected _debug = Debugging;\r\n\r\n  #datasetContext?: UmbPropertyDatasetContext;\r\n\r\n  #notificationContext: UmbNotificationContext | undefined = undefined;\r\n\r\n  #workspaceContext: UmbDocumentWorkspaceContext | undefined = undefined;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.consumeContext(UMB_NOTIFICATION_CONTEXT, (notificationContext) => {\r\n      this.#notificationContext = notificationContext;\r\n      this._commonUtilities = new CommonUtilities(this.localize, this.#notificationContext);//ToDo: should be singleton via context(?)\r\n    });\r\n\r\n    this.consumeContext(UMB_DOCUMENT_WORKSPACE_CONTEXT, (context) => {\r\n      this.#workspaceContext = context;\r\n      this.observe(this.#workspaceContext?.unique, (key) => {\r\n        if (key) {\r\n          this.documentUnique = key;\r\n        }\r\n      }, \"_observeWorkspaceStatus\");\r\n    });\r\n\r\n    this.consumeContext(UMB_PROPERTY_DATASET_CONTEXT, async (context) =>\r\n      this.getSettings(context)\r\n    );\r\n  }\r\n\r\n  protected async firstUpdated() {\r\n    // console.debug(\"firstUpdated start\");\r\n    await this.setUpdateStatus();\r\n    // console.debug(\"firstUpdated end\");\r\n  }\r\n\r\n  override connectedCallback(): void {\r\n    super.connectedCallback();\r\n\r\n  }\r\n\r\n  override disconnectedCallback(): void {\r\n    try {\r\n      super.disconnectedCallback();\r\n\r\n      // this.#workspaceContext?.destroy();\r\n      // this.#datasetContext?.destroy();\r\n      // this._commonUtilities?.destroy();\r\n\r\n      this.#workspaceContext = undefined;\r\n      this.#datasetContext = undefined;\r\n      this.#notificationContext = undefined;\r\n      this._commonUtilities = undefined;\r\n    } catch (e) {\r\n      console.error(\"Error in disconnectedCallback:\", e);\r\n    }\r\n  }\r\n\r\n  protected override update(changedProperties: PropertyValues): void {\r\n    super.update(changedProperties);\r\n\r\n    console.debug(\"update changedProperties:\", changedProperties);\r\n    // console.debug(\"update documentKey:\", this.documentUnique);\r\n  }\r\n\r\n  protected async setUpdateStatus() {\r\n    if (this.updateStatus) return;\r\n\r\n    await this._commonUtilities?.getUpdateStatus(this.#notificationContext).then((status) => {\r\n      if (status) {\r\n        this.updateStatus = status;\r\n      }\r\n    });\r\n  }\r\n\r\n  private getLayoutDataSettings(): UmbBlockDataValueModel<unknown>[] | undefined {\r\n    if (!this.datasetSettings?.length) { return; }\r\n\r\n    const layout = (this as UmbBlockEditorCustomViewElement).layout;\r\n    return this.datasetSettings.filter(\r\n      (s) => layout?.settingsKey === s.key\r\n    )[0]?.values;\r\n  }\r\n\r\n  protected getLayoutSettings(sizeDefault: string = \"h1\"): LayoutSettings {\r\n    const rVal = {\r\n      size: sizeDefault,\r\n      inlineStyle: \"\"\r\n    };\r\n\r\n    const settings = this.getLayoutDataSettings();\r\n    if (!settings?.length) { return rVal; }\r\n\r\n    rVal.size =\r\n      settings\r\n        .filter((v) => v.alias === \"size\")[0]\r\n        ?.value?.toString()\r\n        .toLowerCase() ?? rVal.size;\r\n\r\n    const color = { label: \"\", value: \"\" };\r\n    const colorSetting =\r\n      (settings.filter((v) => v.alias === \"color\")[0]?.value as ColorType) ?? color;\r\n    if (colorSetting?.value) {\r\n      if (colorSetting.value && !this.isTransparentColor(colorSetting.value)) {\r\n        rVal.inlineStyle = `color: ${colorSetting.value};`;\r\n      }\r\n    }\r\n\r\n    const margin =\r\n      (settings.filter((v) => v.alias === \"margin\")[0]?.value as string) ??\r\n      \"\";\r\n    if (margin) {\r\n      rVal.inlineStyle += `margin: ${margin};`;\r\n    }\r\n\r\n    const minHeight = (settings?.find((v) => v.alias === \"minHeight\")?.value ?? \"0\").toString();\r\n    if (minHeight) {\r\n      rVal.inlineStyle += `min-height: ${minHeight};`;\r\n    }\r\n\r\n    if (rVal.inlineStyle) {\r\n      rVal.inlineStyle = `style=\"${rVal.inlineStyle}\"`;\r\n    }\r\n\r\n    return rVal;\r\n  }\r\n\r\n  protected isTransparentColor(color: string) {\r\n    return color === TransparentBackgroundColor || color === 'transparent' || color === 'rgba(0, 0, 0, 0)' || color === 'rgba(255, 255, 255, 0)';\r\n  }\r\n\r\n  protected async getSettings(context: any) {\r\n    this.#datasetContext = context;\r\n    this.observe(\r\n      this.#datasetContext?.properties,\r\n      async (properties) => {\r\n        const pageProperties = properties as Array<UmbPropertyValueDataPotentiallyWithEditorAlias>;\r\n        if (pageProperties?.length) {\r\n          const allGridValues = pageProperties\r\n            .filter((v) => v.editorAlias === \"Umbraco.BlockGrid\") as Array<UmbPropertyValueDataPotentiallyWithEditorAlias>;\r\n\r\n          const editSettingsPath = this.config?.editSettingsPath ?? \"\";\r\n\r\n          let thisGrid = allGridValues[0];\r\n          if (allGridValues.length > 1) {\r\n            for (let i = 0; i < allGridValues.length; i++) {\r\n              const grid = allGridValues[i];\r\n              if (grid.alias && (editSettingsPath.indexOf(grid.alias) >= 0)) {\r\n                thisGrid = grid;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n          const gridValues = thisGrid.value as UmbBlockGridValueModel;\r\n\r\n          this.prozessSettings(gridValues);\r\n\r\n          this.lastStepObservingProperties(pageProperties);\r\n        }\r\n      },\r\n      \"_observeProperties\"\r\n    );\r\n  }\r\n\r\n  protected async prozessSettings(gridValues: UmbBlockGridValueModel) {\r\n    this.datasetSettings = gridValues.settingsData;\r\n  }\r\n\r\n  protected async lastStepObservingProperties(pageProperties: Array<UmbPropertyValueDataPotentiallyWithEditorAlias>) {\r\n    if (!pageProperties) { return; }\r\n  }\r\n}\r\n\r\nexport default WysiwgBaseBlockEditorCustomViewElement;\r\n\r\ndeclare global {\r\n  interface HTMLElementTagNameMap {\r\n    [customElementName]: WysiwgBaseBlockEditorCustomViewElement;\r\n  }\r\n}\r\n"],"names":["_datasetContext","_notificationContext","_workspaceContext","customElementName","WysiwgBaseBlockEditorCustomViewElement","UmbElementMixin","LitElement","Debugging","__privateAdd","UMB_NOTIFICATION_CONTEXT","notificationContext","__privateSet","CommonUtilities","__privateGet","UMB_DOCUMENT_WORKSPACE_CONTEXT","context","_a","key","UMB_PROPERTY_DATASET_CONTEXT","e","changedProperties","status","layout","_b","s","sizeDefault","rVal","settings","v","color","colorSetting","_c","margin","_d","minHeight","_e","TransparentBackgroundColor","properties","pageProperties","allGridValues","editSettingsPath","thisGrid","i","grid","gridValues","__decorateClass","property","state","customElement"],"mappings":"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"}